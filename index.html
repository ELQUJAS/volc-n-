<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>SISTEMA T√ÅCTICO VILLARRICA - EMERGENCIA</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        html, body { height: 100%; margin: 0; background: #001a2d; font-family: sans-serif; overflow: hidden; }
        #main-container { display: flex; height: 100%; width: 100%; }
        #map { flex-grow: 1; height: 100%; position: relative; background: #000; }
        
        #side-panel { width: 350px; background: #fff; border-left: 2px solid #00ffcc; display: flex; flex-direction: column; z-index: 2000; }
        #panel-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        #search-section { padding: 15px; background: #00283c; color: #fff; }
        .search-input { width: 100%; padding: 10px; margin-bottom: 5px; border-radius: 4px; border: none; box-sizing: border-box; font-weight: bold; }
        
        #stats-overlay { position: absolute; top: 15px; left: 60px; z-index: 1000; background: rgba(0,40,60,0.9); color: #00ffcc; padding: 10px; border-radius: 5px; border: 1px solid #00ffcc; pointer-events: none; }
        
        .info-card { border-left: 5px solid #007bb5; background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .riesgo-rojo { border-left-color: #ff0000; background: #fff0f0; }

        /* Estilo para los clusters t√°cticos */
        .cluster-tactico { border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; color: white; font-weight: bold; }
        .c-small { background: #fb8c00; }
        .c-med { background: #f4511e; }
        .c-large { background: #b71c1c; }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="map">
            <div id="stats-overlay">
                <div style="font-size:10px;">VIVIENDAS EN VISTA</div>
                <div id="viviendas-count" style="font-size:20px; font-weight:900;">0</div>
            </div>
        </div>
        
        <div id="side-panel">
            <div id="panel-content">
                <h3 style="color:#00283c; border-bottom: 2px solid #00ffcc;">INFO PREDIAL</h3>
                <div id="content-display">
                    <p style="color: #666; text-align: center; margin-top: 50px;">
                        Esperando selecci√≥n en el mapa...
                    </p>
                </div>
            </div>
            
            <div id="search-section">
                <label style="font-size: 10px; font-weight: 800;">BUSCADOR DE ROLES</label>
                <input type="text" id="rol-search" class="search-input" placeholder="Ej: 125-4..." oninput="filtrarRoles()">
                <div id="suggestions" style="background: white; color: black; max-height: 100px; overflow-y: auto; display: none; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script> 

    <script src="data/riesgo_volcan_zonas_3.js"></script>
    <script src="data/subdivisionesriesgovolcanico_4.js"></script>
    <script src="data/PET_5.js"></script>
    <script src="data/construccionesrurales__6.js"></script>

    <script>
        // 1. INICIALIZACI√ìN SEGURA
        var map;
        try {
            map = L.map('map', { zoomControl: false }).setView([-39.33, -72.08], 12);
        } catch (e) {
            document.body.innerHTML = "<h2 style='color:white; padding:20px;'>Error al cargar el mapa. Verifique su conexi√≥n a internet.</h2>";
        }

        var gHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 22 }).addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        // 2. CONTROL DE CAPAS Y DATOS
        var layer_route = L.layerGroup().addTo(map);

        function getRiskColor(d) {
            d = d ? String(d).toUpperCase() : "";
            if (d.includes("ALI 1")) return "#FF0000";
            if (d.includes("ALI 2")) return "#B22222";
            if (d.includes("MLI"))   return "#FF8C00";
            if (d.includes("MI"))    return "#FFD700";
            if (d.includes("BLI"))   return "#FFFF00";
            return "#CCCCCC";
        }

        // Cargar Zonas de Riesgo
        var layer_riesgo = L.geoJson(typeof json_riesgo_volcan_zonas_3 !== 'undefined' ? json_riesgo_volcan_zonas_3 : null, {
            style: function(f) {
                return { stroke: true, color: "#fff", weight: 0.5, fillColor: getRiskColor(f.properties.descriptio || f.properties.DESCRIPTIO), fillOpacity: 0.5 };
            },
            interactive: false
        }).addTo(map);

        // Cargar Predios
        var layer_predios = L.geoJson(typeof subdivisionesriesgovolcanico_4 !== 'undefined' ? subdivisionesriesgovolcanico_4 : null, {
            style: { color: "#fff", weight: 1, fillOpacity: 0.1 },
            interactive: false
        }).addTo(map);

        // Cargar Viviendas con Cl√∫steres
        var layer_viviendas = L.geoJson(typeof json_construccionesrurales__6 !== 'undefined' ? json_construccionesrurales__6 : null, {
            pointToLayer: function(f, latlng) {
                return L.marker(latlng, { icon: L.divIcon({ html: 'üè†', className: '', iconSize: [15, 15] }) });
            }
        });

        var clusterV = L.markerClusterGroup({
            iconCreateFunction: function(c) {
                var n = c.getChildCount();
                var cls = n < 20 ? 'c-small' : n < 100 ? 'c-med' : 'c-large';
                return L.divIcon({ html: '<div>' + n + '</div>', className: 'cluster-tactico ' + cls, iconSize: [35, 35] });
            }
        }).addLayer(layer_viviendas).addTo(map);

        // 3. L√ìGICA DE INTERACCI√ìN (CLIC)
        map.on('click', function(e) {
            var pt = turf.point([e.latlng.lng, e.latlng.lat]);
            var sideHtml = "";
            var predioDetectado = null;

            // Detectar Predio
            layer_predios.eachLayer(function(l) {
                if (turf.booleanPointInPolygon(pt, l.feature)) {
                    predioDetectado = l.feature.properties;
                }
            });

            if (predioDetectado) {
                sideHtml += "<div class='info-card'><b>üè† PREDIO SELECCIONADO</b><br>";
                sideHtml += "ROL: " + (predioDetectado.ROL || "Sin info") + "<br>";
                sideHtml += "N¬∞ RECEPCI√ìN: " + (predioDetectado.NUMERO_REC || predioDetectado.NUM_REC || "Sin info") + "</div>";
            }

            // Detectar Riesgo
            layer_riesgo.eachLayer(function(l) {
                if (turf.booleanPointInPolygon(pt, l.feature)) {
                    var r = (l.feature.properties.descriptio || "Zona Riesgo").toUpperCase();
                    sideHtml += "<div class='info-card riesgo-rojo'><b>üåã NIVEL DE RIESGO</b><br>" + r + "</div>";
                }
            });

            document.getElementById('content-display').innerHTML = sideHtml || "<p style='text-align:center;'>Punto sin informaci√≥n t√©cnica registrada.</p>";
        });

        // 4. ESTAD√çSTICAS REAL-TIME
        map.on('moveend', function() {
            var b = map.getBounds();
            var count = 0;
            layer_viviendas.eachLayer(function(l) {
                if (b.contains(l.getLatLng())) count++;
            });
            document.getElementById('viviendas-count').innerText = count;
        });

        function filtrarRoles() {
            var val = document.getElementById('rol-search').value.toUpperCase();
            var sug = document.getElementById('suggestions');
            sug.innerHTML = "";
            if (val.length < 2) { sug.style.display = 'none'; return; }
            
            var matchCount = 0;
            layer_predios.eachLayer(function(l) {
                var r = String(l.feature.properties.ROL || "");
                if (r.includes(val) && matchCount < 5) {
                    var d = document.createElement('div');
                    d.innerHTML = "üìç ROL " + r;
                    d.style.padding = "8px"; d.style.cursor = "pointer";
                    d.onclick = function() {
                        map.flyTo(l.getBounds().getCenter(), 17);
                        sug.style.display = 'none';
                    };
                    sug.appendChild(d);
                    matchCount++;
                }
            });
            sug.style.display = matchCount > 0 ? 'block' : 'none';
        }

    </script>
</body>
</html>
