<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <title>GESTI√ìN DE RIESGO VOLC√ÅNICO - VILLARRICA</title>
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
        
        <style>
            /* --- ESTILOS GENERALES --- */
            html, body { height: 100%; margin: 0; background: #f0f2f5; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
            #main-container { display: flex; height: 100%; width: 100%; }
            #map { flex-grow: 1; height: 100%; background: #e0e0e0; z-index: 1; }
            #side-panel { width: 350px; background: #ffffff; border-left: 1px solid #d0d0d0; padding: 20px; z-index: 2000; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
            
            .panel-header { border-bottom: 3px solid #007bb5; padding-bottom: 15px; margin-bottom: 20px; color: #0056b3; text-transform: uppercase; font-weight: 700; font-size: 18px; text-align: center; letter-spacing: 0.5px; }
            
            /* BUSCADOR */
            .search-container { position: relative; margin-bottom: 20px; }
            .search-box { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; transition: border-color 0.3s; }
            .search-box:focus { border-color: #007bb5; outline: none; }
            .search-icon { position: absolute; top: 50%; left: 10px; transform: translateY(-50%); color: #999; }

            /* FICHAS T√âCNICAS */
            .info-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #999; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            .riesgo-box { border-left-color: #d9534f; background: #fff5f5; }
            .predio-box { border-left-color: #5bc0de; background: #f0faff; }
            .pet-box { border-left-color: #5cb85c; background: #f0fff0; }
            .stats-box { border-left-color: #f0ad4e; background: #fffaf0; }
            
            .card-title { font-weight: 700; font-size: 13px; color: #333; margin-bottom: 10px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            .data-row { font-size: 12px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dotted #eee; padding-bottom: 4px; }
            .data-label { text-transform: uppercase; font-weight: 600; color: #666; font-size: 10px; }
            .data-value { color: #000; font-weight: 600; font-size: 12px; text-align: right; }

            /* --- CLUSTERS DE VIVIENDAS (DISE√ëO SIMPLE) --- */
            .cluster-simple { 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                color: white; 
                font-weight: bold; 
                font-family: Arial, sans-serif; 
                border: 2px solid white; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            }
            .c-low { background: #28a745; } /* Verde */
            .c-med { background: #ffc107; color: #333; } /* Amarillo */
            .c-high { background: #dc3545; } /* Rojo */

            /* ICONO PET */
            .pet-icon-wrapper { background: none; border: none; }
            .pet-marker { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #007bb5; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

            .leaflet-control-layers-expanded { box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 4px; font-family: 'Segoe UI', sans-serif; font-size: 13px; }
            .leaflet-bar a { background-color: #fff; border-bottom: 1px solid #ccc; color: #444; }
        </style>
    </head>
    <body>
        <div id="main-container">
            <div id="map"></div>
            <div id="side-panel">
                <div class="panel-header">GESTI√ìN DE RIESGO VOLC√ÅNICO</div>
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="rolSearch" class="search-box" placeholder="Buscar ROL (Ej: 123-4)..." onkeyup="searchByRol()">
                </div>
                <div id="content-display">
                    <p style="text-align:center; color:#777; margin-top:60px; font-style:italic;">Haga clic en el mapa para analizar una zona o predio.</p>
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
        <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script> 

        <script src="data/riesgo_volcan_zonas_3.js"></script>
        <script src="data/subdivisionesriesgovolcanico_4.js"></script>
        <script src="data/PET_5.js"></script>
        <script src="data/construccionesrurales__6.js"></script>

        <script>
        // --- 1. CONFIGURACI√ìN DEL MAPA ---
        var map = L.map('map', { zoomControl: false }).fitBounds([[-39.40, -72.29], [-39.26, -72.00]]);
        L.control.zoom({ position: 'topleft' }).addTo(map);

        var gHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 22, attribution: 'Google Hybrid' }).addTo(map);
        var gRelieve = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 22, attribution: 'Google Terrain' });
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'OpenStreetMap' });

        // --- 2. CAPA DE RIESGO ---
        var layer_riesgo = L.geoJson(json_riesgo_volcan_zonas_3, {
            style: function(f) {
                var d = String(f.properties['descriptio'] || "").toUpperCase();
                var col = "#ffffff";
                if (/ALI\s?1/.test(d)) col = "#d9534f";      
                else if (/ALI\s?2/.test(d)) col = "#f0ad4e"; 
                else if (/MLI/.test(d)) col = "#5bc0de";     
                else if (/BLI/.test(d)) col = "#5cb85c";     
                return { stroke: true, color: "#fff", weight: 1, fillColor: col, fillOpacity: 0.4 };
            }
        }).addTo(map);

        // --- 3. CAPA PET ---
        var petIcon = L.divIcon({ className: 'pet-icon-wrapper', html: `<div class="pet-marker"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>`, iconSize: [32, 32], iconAnchor: [16, 32] });
        
        var layer_PET = L.geoJson(json_PET_5, { 
            pointToLayer: (f, latlng) => L.marker(latlng, { icon: petIcon }),
            onEachFeature: (f, l) => { l.on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                document.getElementById('content-display').innerHTML = `
                    <div class="info-card pet-box">
                        <span class="card-title">üõ°Ô∏è PUNTO DE ENCUENTRO TRANSITORIO (PET)</span>
                        <div class="data-row"><span class="data-label">NOMBRE/UBICACI√ìN:</span><span class="data-value">${f.properties.descriptio || f.properties.Nombre || 'Zona Segura'}</span></div>
                    </div>`;
            }); }
        }).addTo(map);

        // --- 4. CLUSTERS DE VIVIENDAS (DISE√ëO SIMPLE Y POSICI√ìN CORREGIDA) ---
        var clusterV = L.markerClusterGroup({ 
            maxClusterRadius: 60,
            showCoverageOnHover: false,
            iconCreateFunction: function(cluster) {
                var count = cluster.getChildCount();
                var cClass = count < 10 ? 'c-low' : count < 50 ? 'c-med' : 'c-high';
                var size = count < 10 ? 30 : count < 50 ? 40 : 50;
                return L.divIcon({ html: `<span>${count}</span>`, className: `cluster-simple ${cClass}`, iconSize: [size, size] });
            }
        });

        // Carga y posicionamiento exacto de viviendas
        L.geoJson(json_construccionesrurales__6, {
            pointToLayer: function(f, latlng) {
                // Se asegura de usar las coordenadas exactas del GeoJSON
                return L.marker(latlng, { 
                    icon: L.divIcon({ 
                        html: '<svg viewBox="0 0 24 24" width="14" height="14"><circle cx="12" cy="12" r="10" fill="#5bc0de" stroke="white" stroke-width="2"/></svg>', 
                        className: '', iconSize: [14, 14], iconAnchor: [7, 7] 
                    }) 
                });
            },
            onEachFeature: function(f, l) {
                clusterV.addLayer(l);
            }
        });
        map.addLayer(clusterV);

        var layer_predios = L.geoJson(json_subdivisionesriesgovolcanico_4, { style: { color: "#fff", weight: 1.5, fillOpacity: 0 } }).addTo(map);

        // --- 5. MOTOR DE AN√ÅLISIS ---
        function getStableProp(p, keys) {
            for (let k of keys) {
                let search = k.toUpperCase().replace(/[\s_]/g, '');
                let foundKey = Object.keys(p).find(original => original.toUpperCase().replace(/[\s_]/g, '') === search);
                if (foundKey && p[foundKey] !== null && String(p[foundKey]).trim() !== "" && String(p[foundKey]).toLowerCase() !== "null") return p[foundKey];
            }
            return "Sin Informaci√≥n";
        }

        function findClosestPET(latlng) {
            let minDist = Infinity;
            let closest = null;
            layer_PET.eachLayer(l => {
                let d = map.distance(latlng, l.getLatLng());
                if (d < minDist) { minDist = d; closest = l.feature.properties; }
            });
            return { name: closest ? (closest.descriptio || closest.Nombre) : "No detectado", dist: (minDist / 1000).toFixed(2) };
        }

        function searchByRol() {
            let val = document.getElementById('rolSearch').value.trim();
            if (val.length < 3) return;
            layer_predios.eachLayer(l => {
                let rol = String(l.feature.properties.ROL || l.feature.properties.Rol);
                if (rol === val) { map.fitBounds(l.getBounds()); triggerScan(l.getBounds().getCenter()); }
            });
        }

        function triggerScan(latlng) {
            var pt = [latlng.lng, latlng.lat];
            var html = "";
            var zonasEncontradas = [];
            var rolesUnicos = new Set();

            layer_riesgo.eachLayer(l => { if (turf.booleanPointInPolygon(pt, l.feature)) zonasEncontradas.push(l.feature); });
            if (zonasEncontradas.length > 0) {
                let z = zonasEncontradas.length > 1 ? zonasEncontradas.filter(x => !x.properties.descriptio.toUpperCase().includes("ALI 1"))[0] || zonasEncontradas[0] : zonasEncontradas[0];
                
                let countV = 0;
                clusterV.eachLayer(v => { if (turf.booleanPointInPolygon([v.getLatLng().lng, v.getLatLng().lat], z.feature)) countV++; });
                
                html += `<div class="info-card riesgo-box"><span class="card-title">üåã ZONA VOLC√ÅNICA DETECTADA</span>
                    <div class="data-row"><span class="data-label">CLASIFICACI√ìN:</span><span class="data-value">${z.properties.descriptio.toUpperCase()}</span></div></div>`;
                html += `<div class="info-card stats-box"><span class="card-title">üìä AN√ÅLISIS DE EXPOSICI√ìN (ZONA)</span>
                    <div class="data-row"><span class="data-label">TOTAL VIVIENDAS:</span><span class="data-value">${countV}</span></div>
                    <div class="data-row"><span class="data-label">POBLACI√ìN ESTIMADA:</span><span class="data-value">~${Math.round(countV * 4.2)} personas</span></div></div>`;
            }

            layer_predios.eachLayer(l => {
                if (turf.booleanPointInPolygon(pt, l.feature)) {
                    let p = l.feature.properties;
                    let rol = getStableProp(p, ['ROL']);
                    if (!rolesUnicos.has(rol)) {
                        rolesUnicos.add(rol);
                        let pet = findClosestPET(latlng);
                        let houses = 0;
                        clusterV.eachLayer(v => { if (turf.booleanPointInPolygon([v.getLatLng().lng, v.getLatLng().lat], l.feature)) houses++; });
                        
                        let nRec = getStableProp(p, ['NUMERO_REC', 'NUM_REC']);
                        if (nRec.length === 4 && parseInt(nRec) >= 1900 && parseInt(nRec) <= 2100) nRec = "Sin Informaci√≥n (A√±o)";

                        html += `<div class="info-card predio-box"><span class="card-title">üìë FICHA PREDIAL - ROL: ${rol}</span>
                            <div class="data-row"><span class="data-label">SECTOR:</span><span class="data-value">${getStableProp(p, ['ZONAS', 'ZONA', 'SECTOR'])}</span></div>
                            <div class="data-row"><span class="data-label">N¬∞ RECEPCI√ìN:</span><span class="data-value">${nRec}</span></div>
                            <div class="data-row"><span class="data-label">VIVIENDAS EN PREDIO:</span><span class="data-value">${houses}</span></div>
                            <div style="margin-top:10px; pt-2; border-top:1px solid #eee;">
                                <span class="data-label" style="color:#d9534f;">üö© LOG√çSTICA DE EVACUACI√ìN:</span>
                                <div class="data-row"><span class="data-label">PET M√ÅS CERCANO:</span><span class="data-value">${pet.name}</span></div>
                                <div class="data-row"><span class="data-label">DISTANCIA APROX.:</span><span class="data-value">${pet.dist} km</span></div>
                            </div>
                        </div>`;
                    }
                }
            });
            document.getElementById('content-display').innerHTML = html || "Zona sin datos registrados.";
        }

        map.on('click', e => triggerScan(e.latlng));

        // --- 6. LEYENDA TOTAL ---
        var baseMaps = { "üåê H√≠brido Google": gHybrid, "‚õ∞Ô∏è Relieve Topo": gRelieve, "üó∫Ô∏è OpenStreetMap": osm };
        var overlays = { "üåã Zonas Volc√°nicas": layer_riesgo, "üè† Viviendas (Clusters)": clusterV, "üìè Predios Rurales": layer_predios, "üü¢ Puntos PET": layer_PET };
        L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

        </script>
    </body>
</html>
